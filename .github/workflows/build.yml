name: Build

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'
        check-latest: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install system dependencies
      run: |
        sudo apt update && sudo apt install -y protobuf-compiler jq unzip wget

    - name: Clone Repo
      run: |
        git clone https://github.com/Vespa314/cflow.git
        npm install -g pnpm

    - name: Build Frontend (完善 Protobuf 依赖 + 修复生成命令)
      run: |
        cd cflow/web
        pnpm i --frozen-lockfile
        cd ..
        
        # 1. 下载完整的 Google Protobuf 公共依赖（含标准类型和 API 定义）
        echo "下载 Google Protobuf 公共依赖..."
        mkdir -p ./proto/google/{api,protobuf}
        # 标准 Protobuf 类型（解决 google/protobuf/xxx.proto 缺失）
        wget -qO ./proto/google/protobuf/descriptor.proto https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/descriptor.proto
        wget -qO ./proto/google/protobuf/empty.proto https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/empty.proto
        wget -qO ./proto/google/protobuf/timestamp.proto https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/timestamp.proto
        wget -qO ./proto/google/protobuf/field_mask.proto https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/field_mask.proto
        # Google API 定义（解决 google/api/annotations.proto 缺失）
        wget -qO ./proto/google/api/annotations.proto https://raw.githubusercontent.com/googleapis/googleapis/master/google/api/annotations.proto
        wget -qO ./proto/google/api/http.proto https://raw.githubusercontent.com/googleapis/googleapis/master/google/api/http.proto
        
        # 2. 确认 proto 文件路径
        PROTO_DIR="./proto/api/v2"
        if [ ! -d "$PROTO_DIR" ]; then
          PROTO_DIR="./web/proto/api/v2"
        fi
        echo "使用 proto 文件路径：$PROTO_DIR"
        
        # 3. 修复 protoc 命令（明确指定输入文件，避免 "Missing output directives"）
        echo "生成 TypeScript 类型文件..."
        protoc \
          --proto_path=./proto \  # 依赖查找根目录
          --plugin=./web/node_modules/.bin/protoc-gen-ts_proto \
          --ts_proto_out=./web/src/types/proto \  # 输出目录
          --ts_proto_opt=esModuleInterop=true,forceLong=string,useOptionals=messages,outputTypeRegistry=true \
          $(find $PROTO_DIR -name "*.proto")  # 明确输入所有 proto 文件
        
        # 4. 强制创建输出目录（防止生成失败）
        mkdir -p ./web/src/types/proto/api/v2
        echo "类型文件生成完成，目录结构："
        ls -la ./web/src/types/proto/api/v2/
        
        # 5. 前端编译
        cd web
        pnpm build
        
        # 6. 复制前端产物
        mkdir -p ../artifact
        rm -rf ../server/router/frontend/dist
        mkdir -p ../server/router/frontend
        cp -R dist ../server/router/frontend/dist
        cd ../..

    - name: Build binary
      run: |
        cd cflow
        # 编译多架构二进制（保留原有逻辑）
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow.exe && cd artifact && tar -czvf ../cflow-windows-amd64.tar.gz * && cd ..
        GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-freebsd-amd64.tar.gz * && cd ..
        GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-darwin-amd64.tar.gz * && cd ..
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-linux-amd64.tar.gz * && cd ..
        # 新增 Linux-arm64 架构编译（适配需求）
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-linux-arm64.tar.gz * && cd ..
        cd ..
        
    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: cflow-pre-built
        path: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
            cflow/cflow-linux-arm64.tar.gz  # 新增 arm64 产物
            
    - name: Generate release tag (兼容无标签场景)
      id: tag
      run: |
        # 若仓库无标签，生成默认标签 v1.0.0
        LATEST_TAG=$(wget -qO- https://api.github.com/repos/Vespa314/cflow/tags | jq -r '.[0].name // "v1.0.0"' | sed 's/^v//')
        echo "release_tag=v$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "最终发布标签：v$LATEST_TAG"

    - name: Delete existing tag (if exists)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG_NAME: ${{ steps.tag.outputs.release_tag }}
      run: |
        cd cflow
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -d "$TAG_NAME"
          echo "删除本地标签 $TAG_NAME"
        fi
        git push origin --delete "$TAG_NAME" 2>/dev/null || echo "远程标签 $TAG_NAME 不存在"

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        files: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
            cflow/cflow-linux-arm64.tar.gz
        overwrite: true
        draft: false
        prerelease: false

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 8
